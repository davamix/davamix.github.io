<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Software Developer - Blog">
    <meta name="author" content="Daniel Valcarce">
    <meta name="og:tile" content="Software Developer - Blog">
    <meta name="og:description" content="Software Developer and Machine Learning apprentice">
    <meta name="og:image" content="https://raw.githubusercontent.com/davamix/davamix.github.io/master/images/binary.webp">
    <meta name="og:url" content="https://davamix.net/">
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:domain" content="davamix.net"/>
    <meta name="twitter:title" content="Daniel Valcarce web">
    <meta name="twitter:description" content="Software Developer and Machine Learning apprentice">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/davamix/davamix.github.io/master/images/binary.webp">

    <title>Software Developer - Blog</title>

    <!-- Load JQuery at the beginning in order to run functions in comments.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://davamix.net/scripts/comments.js"></script>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://davamix.net/styles/main.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg fixed-top" style="background-color: dodgerblue">
        <a class="navbar-brand" href="#">Daniel Valcarce - Software Developer</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarLinks" aria-controls="navbarLinks"
            aria-expanded="false" aria-label="Toggle navigation">
            <i class="far fa-bars fa-2x" style="color:white"></i>
        </button>

        <!-- Section links -->
        <div class="collapse navbar-collapse" id="navbarLinks">
            <ul class="navbar-nav mr-2">
                <li class="nav-item">
                    <a class="nav-link" href="https://davamix.net" title="Home - Blog">
                        <div class="d-inline-block d-lg-none">
                            <i class="fas fa-home fa-2x"></i>
                            <span>Home - Blog</span>
                        </div>
                        <i class="fas fa-home fa-3x d-lg-inline-block d-none"></i>
                    </a>
                </li>
            </ul>
            <ul class="navbar-nav mr-2">
                <li class="nav-item">
                    <a class="nav-link" href="https://davamix.net/sections/code.html" title="Code examples and Katas">
                        <div class="d-inline-block d-lg-none">
                            <i class="fal fa-code fa-2x"></i>
                            <span>Code</span>
                        </div>
                        <i class="fal fa-code fa-3x d-lg-inline-block d-none"></i>
                    </a>
                </li>
            </ul>
            <!-- <ul class="navbar-nav mr-2">
                <li class="nav-item">
                    <a class="nav-link" href="https://davamix.net/sections/projects.html" title="Personal projects">
                        <div class="d-inline-block d-lg-none">
                            <i class="fal fa-lightbulb fa-2x"></i>
                            <span>Personal projects</span>
                        </div>
                        <i class="fal fa-lightbulb fa-3x d-lg-inline-block d-none"></i>
                    </a>
                </li>
            </ul> -->
        </div>

        <!-- Social links -->
        <div class="collapse navbar-collapse" id="navbarLinks">
            <ul class="navbar-nav mr-4">
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://github.com/davamix" title="Code on Github">
                        <div class="d-inline-block d-lg-none">
                            <i class="fab fa-github-square fa-2x"></i>
                            <span>Github</span>

                        </div>
                        <i class="fab fa-github-square fa-3x d-lg-inline-block d-none"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://twitter.com/davamix" title="@davamix on Twitter">
                        <div class="d-inline-block d-lg-none">
                            <i class="fab fa-twitter-square fa-2x"></i>
                            <span>Twitter</span>

                        </div>
                        <i class="fab fa-twitter-square fa-3x  d-lg-inline-block d-none"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://www.linkedin.com/in/danielvalcarce/" title="Linkedin profile">
                        <div class="d-inline-block d-lg-none">
                            <i class="fab fa-linkedin fa-2x"></i>
                            <span>Linkedin</span>

                        </div>
                        <i class="fab fa-linkedin fa-3x  d-lg-inline-block d-none"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://davamix.wordpress.com/" title="Old blog on Wordpress">
                        <div class="d-inline-block d-lg-none">
                            <i class="fab fa-wordpress fa-2x"></i>
                            <span>Old blog</span>

                        </div>
                        <i class="fab fa-wordpress fa-3x  d-lg-inline-block d-none"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="mailto:davamix@gmail.com?subject=[DavamixNet]" title="Contact me at davamix@gmail.com">
                        <div class="d-inline-block d-lg-none">
                            <i class="far fa-at fa-2x"></i>
                            <span>Contact me at davamix@gmail.com</span>

                        </div>
                        <i class="far fa-at fa-3x  d-lg-inline-block d-none"></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="blog">
            <div class="container">
                <!-- POST: GitHub Actions: Build a Xamarin.Forms project and create the APK -->
                <div class="post">
                    <div class="title">
                        <a href="https://davamix.net/posts/github-actions-build-xamarin-forms-poject-and-create-the-apk.html">
                            <h1>GitHub Actions: Build a Xamarin.Forms project and create the APK</h1>
                        </a>
                        <span class="d-flex p-2 date">09-06-2020</span>
                        <hr />
                    </div>

                    <p>In this post I'll show a way to configure a basic workflow in order to build a Xaramin.Forms application and create the APK, only Android at the moment.</p>

                    <p>First of all, the workflow:</p>
                    
                    <div class="code">
                        <code>
                            name: Build<br />
                            <br />
                            on:<br />
                            &nbsp;&nbsp;push:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;branches: [ master ]<br />
                            &nbsp;&nbsp;pull_request:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;branches: [ master ]<br />
                            <br />
                            jobs:<br />
                            &nbsp;&nbsp;# Build App<br />
                            &nbsp;&nbsp;build:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;runs-on: windows-latest<br />
                            <br />
                            &nbsp;&nbsp;&nbsp;&nbsp;env:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SERVICE_APP_KEY: ${{ secrets.SERVICE_APP_KEY }}<br />
                            <br />
                            &nbsp;&nbsp;&nbsp;&nbsp;steps:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- uses: actions/checkout@v2<br />
                            <br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- name: Setup MSBuild<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uses: microsoft/setup-msbuild@v1.0.0<br />
                            <br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- name: Build Solution<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run: msbuild ./MyApplication.sln /restore /p:Configuration=Release<br />
                            <br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- name: Create and Sign the APK<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run: msbuild MyApplication\MyApplication.Android\MyApplication.Android.csproj /t:SignAndroidPackage /p:Configuration=Release /p:OutputPath=bin\Release\<br />
                            <br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- name: Upload artifact<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uses: actions/upload-artifact@v2<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name: MyApplication.apk<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path: MyApplication\MyApplication.Android\bin\Release\com.companyname.myapplication-Signed.apk<br />


                        </code>
                    </div>

                    <p></p>
                    <h3>Step by step</h3>

                    <p>
                        The first lines are self-explanatory so I'll jump to the <mark>build</mark> section.
                    </p>

                    <div class="code">
                        <code>
                            build:<br />
                            &nbsp;&nbsp;runs-on: windows-latest<br />
                        </code>
                    </div>
                    <p>This will configure a Windows machine and all steps for this job will run in this environment. The default shell will be a <em>PowerShell</em>, so we can run scripts in this language.</p>
                    
                    <div class="code">
                        <code>
                            env:<br />
                            &nbsp;&nbsp;SERVICE_APP_KEY: ${{ secrets.SERVICE_APP_KEY }}<br />
                        </code>
                    </div>
                    <p>With this line we create an environment variable, <mark>SERVICE_APP_KEY</mark> with the content of the GitHub secret <mark>secrets.SERVICE_APP_KEY</mark>. The variables created in an upper level can be accessed by its children elements but a variable created in a <em>step</em> level, for example, cannot be accessed from other step or a parent element.</p>

                    <div class="note">
                        A secret in GitHub is a piece of encrypted information that belongs to the repository. To create a secret go to your repository <em>Settings -> Secrets</em>.<br />
                        If you try to print the value of a secret during the build process you will only see something like: SERVICE_APP_KEY: ****
                    </div>
                    <p>Now let's explain the steps.</p>

                    <div class="code">
                        <code>
                            steps:<br />
                            &nbsp;&nbsp;- uses: actions/checkout@v2<br />
                        </code>
                    </div>
                    <p>The first step is the checkout. This action will download all the code to the current machine.</p>

                    <div class="code">
                        <code>
                            - name: Setup MSBuild<br />
                            &nbsp;&nbsp;uses: microsoft/setup-msbuild@v1.0.0<br />
                        </code>
                    </div>
                    <p>The next steps is to use the action <a href="https://github.com/microsoft/setup-msbuild">microsoft/setup-msbuild@v1.0.0</a> in order to configure the environment that allow us to use the <em>msbuild</em> tool.</p>

                    <div class="code">
                        <code>
                            - name: Build Solution<br />
                            &nbsp;&nbsp;run: msbuild ./MyApplication.sln /restore /p:Configuration=Release<br />
                        </code>
                    </div>
                    <p>Build the solution in <em>Release</em> mode.</p>

                    <div class="code">
                        <code>
                            - name: Create and Sign the APK<br />
                            &nbsp;&nbsp;run: msbuild MyApplication\MyApplication.Android\MyApplication.Android.csproj /t:SignAndroidPackage /p:Configuration=Release /p:OutputPath=bin\Release\<br />
                        </code>
                    </div>
                    <p>In order to create and sign the package we will execute the <em>msbuild</em> command over the Android project with the target <mark>/t:SignAndroidPackage</mark>. The configuration should be <mark>Release</mark> and the generated <em>.apk</em> file will be located in <em>{project_folder}\</em><mark>bin\Release</mark></p>
                    <p>The name of the file will be <em>com.companyname.myapplication-Signed.apk</em>. The default name of the package is <em>com.companyname.myapplication</em>, you can change it in the <em>AndroidManifest.xml</em> file or in the properties of the Android project in Visual Studio.</p>
                    <p>This process attach the <em>-Signed</em> suffix to the name.</p>

                    <div class="code">
                        <code>
                            - name: Upload artifact<br />
                            &nbsp;&nbsp;uses: actions/upload-artifact@v2<br />
                            &nbsp;&nbsp;with:<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;name: MyApplication.apk<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;path: MyApplication\MyApplication.Android\bin\Release\com.companyname.myapplication-Signed.apk<br />
                        </code>
                    </div>
                    <p>The last step is to make available the artifact to be downloaded. We will use the action <mark>actions/upload-artifact@v2</mark> with the parameters <mark>name</mark> as the name of the artifact, and the <mark>path</mark>, the path where the package is located.</p>

                    <h3>How to manage the secret keys</h3>

                    <p>The hardcoded keys are not a good practice ;) A better solution could be create an environment variable in your local system, but, how to access from code? One approach I follow is to create a class to manage the secrets and populate it with placeholders, something like:</p>

                    <div class="code">
                        <code>
                            public static class Secrets{<br />
                                &nbsp;&nbsp;public static string ServiceID => "#KEY1#"<br />
                                &nbsp;&nbsp;public static string OtherKey => "#KEY2#"<br />
                            }<br />
                        </code>
                    </div>

                    <p>To replace the placeholders by the valid keys I have a <em>PowerShell</em> script that runs in the <em>pre-build</em> event on Visual Studio.</p>

                    <div class="code">
                        <code>
                            function Replace-Text{<br />
                            &nbsp;&nbsp;<#<br />
                            &nbsp;&nbsp;.SYNOPSIS<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;Replace the $placeholder value by $key value in $file<br />
                            &nbsp;&nbsp;.PARAMETER $file<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;File to replace values. Mandatory<br />
                            &nbsp;&nbsp;.PARAMETER $placeholder<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;Value to be replaced. Mandatory<br />
                            &nbsp;&nbsp;.PARAMETER $key<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;The new value to replace the $placeholder. Mandatory<br />
                            &nbsp;&nbsp;.EXAMPLE<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;Replace-Text file_path "#TEXT TO REPLACE#" "KEY VALUE"<br />
                            &nbsp;&nbsp;#><br />
                            &nbsp;&nbsp;Param(<br />
                                &nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$true)]<br />
                                &nbsp;&nbsp;&nbsp;&nbsp;[string]$file,<br />
                                &nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$true)]<br />
                                &nbsp;&nbsp;&nbsp;&nbsp;[string]$placeholder,<br />
                                &nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$true)]<br />
                                &nbsp;&nbsp;&nbsp;&nbsp;[string]$key<br />
                            &nbsp;&nbsp;)<br />
                            &nbsp;&nbsp;((Get-Content -path $file -Raw) -replace $placeholder, $key) | Set-Content -Path $file<br />
                            }<br />
                            
                            $file = $args[0]<br />
                            $placeholder = $args[1]<br />
                            $key_value = $args[2]<br />
                            
                            Replace-Text $file $placeholder $key_value<br />
                        </code>
                    </div>

                    <p>This script have three parameters:</p>
                    <ul>
                        <li>the <mark>$file</mark> where the placeholder are</li>
                        <li>the <mark>$placeholder</mark> to be replaced</li>
                        <li>the <mark>$key_value</mark> from the environment variable</li>
                    </ul>
                    <p>This script is called from the <em>Pre-build event command line</em>. <em>Project properties -> Build Events</em>:</p>

                    <div class="code">
                        <code>
                            powershell.exe -ExecutionPolicy Unrestricted $(ProjectDir)..\..\Tools\replace-keys-script.ps1 $(ProjectDir)Secrets.cs "`#KEY1`#" $env:SERVICE_APP_KEY<br />
                            <br />
                            powershell.exe -ExecutionPolicy Unrestricted $(ProjectDir)..\..\Tools\replace-keys-script.ps1 $(ProjectDir)Secrets.cs "`#KEY2`#" $env:OTHER_KEY<br />
                        </code>
                    </div>

                    <div class="note">
                        If the placeholder has # characters like #INSERT_KEY_HERE# they must be escaped with grave-accents: "`#INSERT_KEY_HERE`#" in order to escape the comment symbol.
                    </div>

                    <p>Let me show the folder structure:</p>

                    <div class="code">
                        <code>
                            /<br />
                            |- Solution.sln<br />
                            |- Project/<br />
                            |- Project.Android/<br />
                            |- Tools/<br />
                            &nbsp;&nbsp;&nbsp;&nbsp;|- replace-keys-script.ps1<br />
                        </code>
                    </div>

                    <p>Why to use <mark>$(ProjectDir)..\..\Tools</mark> instead of <mark>$(SolutionDir)Tools</mark>? Because <mark>$(SolutionDir)</mark> does not works on GitHub Actions for wharever reason.</p>

                    <p>As you may notice, this process change the content of the files and Git wil mark them. To fix this I do a <em>checkout</em> for all files in the <em>Post-build</em> event:</p>
                    
                    <div class="code">
                        <code>
                            git checkout $(ProjectDir)Secrets.cs<br />
                        </code>
                    </div>

                    <p>After the build process the application will work with correct values and the code remains intact.</p>
                    <p>The only thing we need to do in GitHub is to create the secrets we need for the keys and create the environment variables in the workflow with the same name as we have in out system.</p>

                    <div class="post-references-section">
                        <h2>References</h2>
                        <a href="https://docs.microsoft.com/en-us/xamarin/android/deploy-test/building-apps/build-process" target="_blank" rel="nofollow">Xamarin Android - Build Process</a><br/>
                        <a href="https://github.com/marketplace/actions/setup-msbuild" target="_blank" rel="nofollow">GitHub Action - setup-msbuild</a><br/>
                        <a href="https://stackoverflow.com/a/20638116/844372" target="_blank" rel="nofollow">Prebuild event in Visual Studio replacing $(SolutionDir) with *Undefined*</a><br/>
                        <a href="https://stackoverflow.com/a/56646415/844372" target="_blank" rel="nofollow">How to use VisualStudio SignAndroidPackage in TeamCity?</a><br/>
                    </div>
                </div>
                <div class="footer mt-4">
                    <a class="comments" href="https://davamix.net/posts/github-actions-build-xamarin-forms-poject-and-create-the-apk.html#post-comments">
                        <div id="blog-post-date4"></div>
                    </a>
                    <hr />
                    <script type="text/javascript">
                        GetTotalComments(6);
                    </script>
                </div>

                <!-- POST: Detecting my cats with Detectron2-->
                <div class="post">
                    <div class="title">
                        <a href="https://davamix.net/posts/detecting-my-cats-with-Detectron2.html">
                            <h1>Detecting my cats with Detectron2</h1>
                        </a>
                        <span class="d-flex p-2 date">24-01-2020</span>
                        <hr />
                    </div>

                    <p>
                        In this post I'll show how train a model with Detectron2 with a custom dataset and then apply it detect my cats in a picture or video.
                    </p>
                    
                    <h4>Table of content</h4><br>
                    <ul>
                        <li>Install Detectron2</li>
                        <li>Create your own dataset</li>
                        <li>Steps to annotate an image</li>
                        <li>Training process</li>
                        <li>Data loader</li>
                        <li>Inference</li>
                        <li>References</li>
                    </ul>
                    

                    <span class="anchor" id="install-detectron2"></span>
                    <h3>Install Detectron2</h3>
                    <p>
                        I use the docker version of Detectron2 that installs all the requirements in a few steps:<br/>
                        <strong>1.</strong> Take the required files, <em>Dockerfile</em>, <em>Dockerfile-circleci</em>, <em>docker-compose.yml</em> from <a href="https://github.com/facebookresearch/detectron2/tree/master/docker" rel=”nofollow”>https://github.com/facebookresearch/detectron2/tree/master/docker</a><br/>
                        <strong>2.</strong> Create and run the container with the command:
                        <div class="code">
                            <code class="prompt">
                                docker-compose run --volume=/local/path/to/save/your/files:/tmp:rw detectron2
                            </code>
                        </div>
                    </p>

                    <div class="note">
                        <strong>Note</strong><br/>
                        The installed version of <mark>Pillow</mark> package is 7.0.0, this could fail when you try to train your model showing an error similiar to:<br/>
                        <!-- <img src="../images/train-Detectron2-with-custom-dataset/Pillow-version-error.png" title="Error due the Pillow version"><br/> -->
                        <code>
                            &nbsp;&nbsp;&nbsp;&nbsp;from PIL import Image, ImageOps, ImageEnhance, PILLOW_VERSION <br/>
                            ImportError: cannot import name 'PILLOW_VERSION'
                        </code><br/>
                        The solution is to downgrade the version to 6.2.2:<br/>
                        <div class="code">
                            <code class="prompt">
                                pip install --user Pillow==6.2.2
                            </code>
                        </div>
                    </div>

                    <p>
                        Check the <a href="https://github.com/facebookresearch/detectron2/blob/master/INSTALL.md" rel=”nofollow”>installation guide</a> to install Detectron2 using other methods.
                    </p>

                    <h3>Create your own dataset</h3>
                    <p>
                        The first (and most tedious) step is to annotate the images. For this examples I will use a set of images of my cats, Blacky and Niche:<br/>

                        <div class="image-box">
                            <img src="../images/train-Detectron2-with-custom-dataset/blacky-sample.webp" width="400" height="330" title="Blacky">
                            <img src="../images/train-Detectron2-with-custom-dataset/niche-sample.webp" width="400"  height="330" title="Niche">
                        </div>

                        and I'll use <a href="http://www.robots.ox.ac.uk/~vgg/software/via/" rel=”nofollow”>VIA 2.0.8</a>, it's an easy tool to make the annotations. This is an example of how an annotation looks like:<br/>
                        <div class="image-box">
                            <img src="../images/train-Detectron2-with-custom-dataset/niche-annotation.webp" width="400" height="330" title="Image of a region draw around Niche">
                        </div>
                    </p>

                    <h3>Steps to annotate an image</h3>
                    <div class="note">
                        <strong>Note</strong><br/>
                        - The instructions below are for VIA tool, if you are using a different tool, then jump to the next section.<br/>
                        - Follow this process twice, once for training images, another for validation images.<br/>
                    </div>

                    <p>
                        Before start to annotating the images you must create a region attribute named <mark>Class</mark>, you can change the name if you want, in order to choose which region your are drawing.<br/>
                        <div class="image-box">
                            <img src="../images/train-Detectron2-with-custom-dataset/via-attributes.webp" title="VIA - Attributes panel">
                        </div>
                    </p>

                    <p>
                        Looking the image above, follow these steps:<br/>
                        <strong>1.</strong> Expand the <em>Attributes</em> panel.<br/>
                        <strong>2.</strong> Type the attribute name <mark>Class</mark> on textbox and click on plus symbol.<br/>
                        <strong>3.</strong> Change the <em>Type</em> of the attribute from <mark>text</mark> to <mark>radio</mark>.<br/>
                        <strong>4.</strong> Write all classes available for the dataset, <em>Blacky</em> and <em>Niche</em> in my case, in the <mark>id</mark> field.<br/>
                    </p>

                    <p>
                        Next, the basics steps to annotate the images:<br/>
                        <strong>1.</strong> Add the images to the project clicking on the <em>Add Files</em> button in the <em>Project panel</em>.<br/>
                        <strong>2.</strong> Select one image and start drawing the region using the <em>Poligon region shape</em>.<br/>
                        <strong>3.</strong> To apply the changes press <em>Enter</em> and the region will be saved.<br/>
                        <strong>4.</strong> Click outside of the region, click again on the region and select the class you are annotating.<br/>
                        <div class="note">
                            Sometimes you will need to scroll down / right to see the option list
                        </div>
                        <strong>5.</strong> Once all images are annotated, export the annotations as json. Go <em>Annotation</em> menu, then <em>Export Annotations (as json)</em>.<br/>
                    </p>

                    <p>
                        The json file will contains a section by image similar to this one:
                    </p>

                    <div class="code">
                        <code>
                            "frame80.jpg214814": {<br/>
                            &nbsp;&nbsp;"filename": "frame80.jpg",<br/>
                            &nbsp;&nbsp;"size": 214814,<br/>
                            &nbsp;&nbsp;"regions": [<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;{<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"shape_attributes": {<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"name": "polygon",<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"all_points_x": [<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1096,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1016,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;947,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"all_points_y": [<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;116,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;191,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;231,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"region_attributes": {<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class": "Blacky"<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                            &nbsp;&nbsp;],<br/>
                            &nbsp;&nbsp;"file_attributes": {}<br/>
                            }<br/>
                            ...<br/>
                        </code>
                    </div>
                    <p></p>
                    <h3>Training process</h3>
                    
                    <p>Before to start to explain the code, let me show the folder structure in order to have an idea of where are the code, the data and all this stuff.</p>

                    <div class="image-box">
                        <img src="../images/train-Detectron2-with-custom-dataset/folder_structure.webp" title="folder structe of the project">
                    </div>

                    <p>
                        The <em>data</em> folder contains two folders, <em>train</em> and <em>validation</em>, which contain one folder per class (of course, there are more than one image in the class folder). Also, the <em>train</em> and <em>validation</em> folders have its respective annotation files. The <em>src</em> folder contains the code sepated in different files.
                    </p>

                    <p>
                        Ok, now we are ready to write the code. First things first, we need to import the functions required from detectron2.
                    </p>

                    <div class="code">
                        <code>
                            # train.py<br/>
                            <br/>
                            import os<br/>
                            <br/>
                            from detectron2.data import MetadataCatalog, DatasetCatalog<br/>
                            from detectron2.config import get_cfg<br/>
                            from detectron2 import model_zoo<br/>
                            from detectron2.engine import DefaultTrainer<br/>
                            from loader import get_data_dicts<br/>
                        </code>
                    </div>

                    <p>
                        Next, we'll register both datasets, train and validation, and indicate the name of the classes that we are using.
                    </p>

                    <div class="code">
                        <code>
                            for d in ["train", "val"]:<br/>
                            &nbsp;&nbsp;DatasetCatalog.register("cats_" + d, lambda d=d: get_data_dicts("../data/" + d))<br/>
                            &nbsp;&nbsp;MetadataCatalog.get("cats_" + d).set(thing_classes=["Blacky", "Niche"])<br/>
                            <br/>
                            cats_metadata = MetadataCatalog.get("cats_train")<br/>
                        </code>
                    </div>
                    
                    <p>
                        The <mark>DatasetCatalog.register</mark> function expects two parameters, the name of the dataset, and the function to get the data.<br/>
                        With <mark>MetadataCatalog</mark> we specify which classes are present in the dataset using the attribute thing_classes. To know more about the metadata check the <a href="https://detectron2.readthedocs.io/tutorials/datasets.html#metadata-for-datasets" rel=”nofollow”>documentation</a>.
                    </p>

                    <p>
                        Now let's configure the model:
                    </p>

                    <div class="code">
                        <code>
                            cfg = get_cfg()<br/>
                            cfg.merge_from_file(model_zoo.get_config_file("COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml"))<br/>
                            cfg.DATASETS.TRAIN = ("cats_train",)<br/>
                            cfg.DATASETS.TEST = ()<br/>
                            cfg.DATALOADER.NUM_WORKERS = 4<br/>
                            cfg.MODEL.WEIGHTS = "detectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl"<br/>
                            cfg.SOLVER.IMS_PER_BATCH = 2<br/>
                            cfg.SOLVER.BASE_LR = 0.00025<br/>
                            cfg.SOLVER.MAX_ITER = 700<br/>
                            cfg.MODEL.ROI_HEADS.BATCH_SIZE_PER_IMAGE = 128<br/>
                            cfg.MODEL.ROI_HEADS.NUM_CLASSES = 2<br/>
                        </code>
                    </div>

                    <br/>
                    <ul>
                        <li><strong>get_cfg()</strong>: returns an instance of CfgNode class that allow us to modify the configuration of the model.</li>
                        <li><strong>cfg.merge_from_file</strong>: we use this to apply the original configuration from <em>mask_rcnn_R_50_FPN_3x</em> model to our configuration.</li>
                        <li><strong>cfg.DATASETS.TRAIN</strong>: This is the list of dataset names for training. Important to note the comma at the end.</li>
                        <li><strong>cfg.DATASETS.TEST</strong>: This remains empty for the training purposes.</li>
                        <li><strong>cfg.DATALOADER.NUM_WORKERS</strong>: Number of data loading threads.</li>
                        <li><strong>cfg.MODEL.WEIGHTS</strong>: Pick the weights from <em>mask_rcnn_R_50_FPN_3x</em> model.</li>
                        <li><strong>cfg.SOLVER.IMS_PER_BATCH</strong>: Number of images per batch.</li>
                        <li><strong>cfg.SOLVER.BASE_LR</strong>: Learning rate.</li>
                        <li><strong>cfg.SOLVER.MAX_ITER</strong>: Total iterations (Detectron2 don't use epochs).</li>
                        <li><strong>cfg.MODEL.ROI_HEADS.BATCH_SIZE_PER_IMAGE</strong>: Indicate the number of ROI's (Region of Interest) per training minibatch.</li>
                        <li><strong>cfg.MODEL.ROI_HEADS.NUM_CLASSES</strong>: Number of classes.</li>
                    </ul>                        
                    
                    <p>
                        Basically what we are doing here is to get configuration from an existing model, <em>mask_rcnn_R_50_FPN_3x</em>, then we overwrite some of the values like learning rate, iterations, etc...<br/>
                        Check the <a href="https://detectron2.readthedocs.io/modules/config.html#config-references" rel=”nofollow”>documentation</a> about the configuration to know all available options that you can change.
                    </p>
                    
                    <p>
                        And finally it's time to call the training process:
                    </p>

                    <div class="code">
                        <code>
                            os.makedirs(cfg.OUTPUT_DIR, exist_ok=True)<br/>
                            trainer = DefaultTrainer(cfg)<br/>
                            trainer.resume_or_load(resume=False)<br/>
                            trainer.train()<br/>
                        </code>
                    </div>

                    <p></p>
                    <h3>Data loader</h3>
                    
                    <p>
                        Now it's time to implement the function to let Detectron2 know how to obtain the data from the dataset that we registered before with:
                    </p>
                    <div class="code">
                        <code>
                            DatasetCatalog.register("cats_" + d, lambda d=d: get_data_dicts("../data/" + d))
                        </code>
                    </div>

                    <p>
                        The code of <em>loader.py</em> is pretty similar to the function shown in the <a href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5#scrollTo=tjbUIhSxUdm_" target="blank" rel=”nofollow”> Colab notebook</a>
                    </p>

                    <div class="code">
                        <code>
                            # loader.py <br/>
                            <br/>
                            def get_data_dicts(img_dir):<br/>
                            &nbsp;&nbsp;classes = ["Blacky", "Niche"]<br/>
                            <br/>
                            &nbsp;&nbsp;json_file = os.path.join(img_dir, "cats-annotations.json")<br/>
                            &nbsp;&nbsp;with open(json_file) as f:<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;imgs_anns = json.load(f)<br/>
                            <br/>
                            &nbsp;&nbsp;dataset_dicts = []<br/>
                            &nbsp;&nbsp;for idx, v in enumerate(imgs_anns.values()):<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;record = {}<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;if "regions" not in v: continue<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;# Extract info from regions<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;annos = v["regions"]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;objs = []<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;for anno in annos:<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shape_attr = anno["shape_attributes"]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;px = shape_attr["all_points_x"]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;py = shape_attr["all_points_y"]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;poly = [(x + 0.5, y + 0.5) for x, y in zip(px, py)]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;poly = [p for x in poly for p in x]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;region_attr = anno["region_attributes"]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_class = region_attr["Class"]<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;obj = {<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"bbox": [np.min(px), np.min(py), np.max(px), np.max(py)],<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"bbox_mode": BoxMode.XYXY_ABS,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"segmentation": [poly],<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"category_id": classes.index(current_class),<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"iscrowd": 0<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;objs.append(obj)<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;record["annotations"] = objs<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;# Get info of the image<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;filename = os.path.join(img_dir, current_class, v["filename"])<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;height, width = cv2.imread(filename).shape[:2]<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;record["file_name"] = filename<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;record["image_id"] = idx<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;record["height"] = height<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;record["width"] = width<br/>
                            <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;dataset_dicts.append(record)<br/>
                            &nbsp;&nbsp;return dataset_dicts<br/>
                        </code>
                    </div>

                    <p>
                        The function loops through all annotations in the json file and extract the information related with the region, category, etc... of the image.
                    </p>
                    <p>
                        The annotation itself is represented by the dictionary <mark>obj</mark> that contains some specific keys:
                    </p>

                    <ul>
                        <li><strong>bbox</strong>: list of 4 numbers representing the bounding box of the instance.</li>
                        <li><strong>bbox_mode</strong>: the format of the bbox.</li>
                        <li><strong>category_id</strong>: number that represents the category label.</li>
                        <li><strong>iscrowd</strong>: 0 or 1. Whether the instance is labeled as COCO's format.</li>
                    </ul>

                    <p>
                        Also, some extra information is saved in the record dictionary:
                    </p>
                    <ul>
                        <li><strong>file_name</strong>: the fullpath of the image.</li>
                        <li><strong>image_id</strong>: a unique id to identify the image.</li>
                        <li><strong>height</strong>: self explanatory.</li>
                        <li><strong>width</strong>: self explanatory.</li>
                    </ul>

                    <p>
                        To know more about of the dictionary check the <a href="https://detectron2.readthedocs.io/tutorials/datasets.html#register-a-dataset" target="_blank" rel=”nofollow”> documentation</a>.
                    </p>

                    <h3>Inference</h3>
                    
                    <p>
                        It's time to do some predictions and we start with the imports:
                    </p>

                    <div class="code">
                        <code>
                            # inference.py<br/>
                            <br/>
                            import os<br/>
                            import random<br/>
                            import cv2<br/>
                            <br/>
                            from detectron2.config import get_cfg<br/>
                            from detectron2 import model_zoo<br/>
                            from detectron2.engine import DefaultPredictor<br/>
                            from detectron2.utils.visualizer import Visualizer, ColorMode<br/>
                            from detectron2.data import MetadataCatalog<br/>
                            from loader import get_data_dicts<br/>
                        </code>
                    </div>

                    <p>
                        For inference we use a few different functions: <mark>DefaultPredictor</mark>, <mark>Visualizer</mark> and <mark>ColorMode</mark>.
                    </p>
                    <p>
                        Next, we configure the model as we did on the training process, then create the predictor: 
                    </p>
                    
                    <div class="code">
                        <code>
                            classes = ["Blacky", "Niche"]<br/>
                            <br/>
                            cfg = get_cfg()<br/>
                            cfg.merge_from_file(model_zoo.get_config_file("COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml"))<br/>
                            cfg.DATASETS.TEST = ("cats_val",)<br/>
                            cfg.MODEL.WEIGHTS = os.path.join(cfg.OUTPUT_DIR, "model_final.pth")<br/>
                            cfg.MODEL.ROI_HEADS.NUM_CLASSES = 2<br/>
                            cfg.MODEL.ROI_HEADS.SCORE_THRESH_TEST = 0.7<br/>
                            <br/>
                            predictor = DefaultPredictor(cfg)<br/>
                        </code>
                    </div>

                    <p>
                        This configuration is similar to the configuration we used in the training but this time the <mark>WEIGHTS</mark> come from our trained model <em>model_final.pth</em>.
                    </p>

                    <div class="code">
                        <code>
                            dataset_dicts = get_data_dicts("../data/validation")<br/>
                            <br/>
                            for idx, d in enumerate(random.sample(dataset_dicts, 3)):<br/>
                            &nbsp;&nbsp;im = cv2.imread(d["file_name"])<br/>
                            &nbsp;&nbsp;outputs = predictor(im)<br/>
                            <br/>
                            &nbsp;&nbsp;v = Visualizer(im[:, :, ::-1], <br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;metadata = MetadataCatalog.get("cats_val").set(<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thing_classes=classes,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thing_colors=[(177, 205, 223), (223, 205, 177)]),<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;scale = 0.8,<br/>
                            &nbsp;&nbsp;&nbsp;&nbsp;instance_mode = ColorMode.IMAGE_BW<br/>
                            &nbsp;&nbsp;)<br/>
                            <br/>
                            &nbsp;&nbsp;pred_class = (outputs['instances'].pred_classes).detach()[0]<br/>
                            &nbsp;&nbsp;pred_score = (outputs['instances'].scores).detach()[0]<br/>
                            <br/>
                            &nbsp;&nbsp;print(f"File: {d['file_name']}")<br/>
                            &nbsp;&nbsp;print(f"--> Class: {classes[pred_class]}, {pred_score * 100:.2f}%")<br/>
                            <br/>
                            &nbsp;&nbsp;# Save image predictions<br/>
                            &nbsp;&nbsp;v = v.draw_instance_predictions(outputs["instances"].to("cpu"))<br/>
                            &nbsp;&nbsp;image_name = f"inference_{idx}.jpg"<br/>
                            &nbsp;&nbsp;cv2.imwrite(image_name, v.get_image()[:, :, ::-1])<br/>
                        </code>
                    </div>

                    <p>
                        To make the predicitions we use 3 random images from the validation dataset.
                    </p>
                    <p>
                        The predictor receive the image in format BGR, the same format that cv2 returns when reads the image. 
                        Once we have the predictions then we create and configure the <mark>Visualizer</mark> that we'll use to show the regions predicted over the original image. 
                    </p>
                    <p>
                        The <mark>Visualizer</mark> accepts as the first parameter the original image but this time in RGB format, that's why we have to reverse the array that cv2 returns when reads the image.<br/>
                        The second parameter is the metadata, which in this case consists of the name of the classes, <em>Blacky</em> and <em>Niche</em>, and the colors applied to the regions of each class.<br/>
                        The <mark>ColorMode.IMAGE_BW</mark> value is used to remove the color of unsegmented pixels (the pixels that don't belong to the predicted region).<br/>
                    </p>

                    <p>
                        At the end we apply the regions predicted over the original image with <mark>v.draw_instance_predictions(outputs["instances"].to("cpu"))</mark>
                    </p>
                    <p>
                        In this case I save the image on disk because I don't have access to XServer from inside Docker, so OpenCV cannot open any window to show the image. In case we worked from our local system we could use:
                    </p>
                    <div class="code">
                        <code>
                            v = v.draw_instance_predictions(outputs["instances"].to("cpu"))<br/>
                            cv2.imshow(v.get_image()[:, :, ::-1])<br/>
                        </code>
                    </div>

                    <div class="image-box">
                        <img src="../images/train-Detectron2-with-custom-dataset/inference_blacky.webp" width="400" height="330" title="Inference Blacky">
                        <img src="../images/train-Detectron2-with-custom-dataset/inference_niche.webp" width="400" height="330" title="Inference Niche">
                    </div>
                    <div class="image-box">
                        <img src="../images/train-Detectron2-with-custom-dataset/inference_both.webp" width="400" height="330" title="Inference Blacky and Niche">
                    </div>
                    
                    <p>
                        Check the <a href="https://github.com/davamix/cats-localization/blob/master/src/test.py" rel=”nofollow”>test.py</a> file in the repository to know how to make inference in a video. Spoiler alert: predicting every frame xD.
                    </p>

                    <div class="post-references-section">
                        <h2 id="references">References</h2>
                        <a href="https://github.com/davamix/cats-localization" target="_blank" rel=”nofollow”>Code repository</a><br/>
                        <a href="https://drive.google.com/open?id=1o9zyd51QCqWG3DlArQnfH4q4clMVQmTY" target="_blank" rel=”nofollow”>Cats dataset</a> (zip file ~39MB)<br/>
                        <a href="https://github.com/facebookresearch/detectron2" target="_blank" rel=”nofollow”>Detectron2 GitHub repository</a><br/>
                        <a href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5" target="_blank" rel=”nofollow”>Detectron2 Colab Notebook</a><br/>
                        <a href="https://detectron2.readthedocs.io/tutorials/datasets.html" target="_blank" rel=”nofollow”>Documentation - Use Custom Datasets</a><br/>
                        <a href="https://detectron2.readthedocs.io/modules/config.html#config-references" target="_blank" rel=”nofollow”>Documentation - Config References</a><br/>
                        <a href="https://detectron2.readthedocs.io/tutorials/models.html" target="_blank" rel=”nofollow”>Documentation - Use Models</a><br/>
                    </div>
                </div> <!-- post -->
                <div class="footer mt-4">
                    <a class="comments" href="https://davamix.net/posts/detecting-my-cats-with-Detectron2.html#post-comments">
                        <div id="blog-post-date4"></div>
                    </a>
                    <hr />
                    <script type="text/javascript">
                        GetTotalComments(5);
                    </script>
                </div>

                <!-- POST: Save video frames as images with OpenCV -->
                <div class="post">
                    <div class="title">
                        <a href="https://davamix.net/posts/save-video-frames-as-images-with-opencv.html">
                            <h1>Save video frames as images with OpenCV</h1>
                        </a>
                        <span class="d-flex p-2 date">15-03-2019</span>
                        <hr />
                    </div>

                    <p>
                        To read a frame we'll use the method <a href="https://docs.opencv.org/4.0.1/d8/dfe/classcv_1_1VideoCapture.html#a473055e77dd7faa4d26d686226b292c1" rel=”nofollow”>read()</a> 
                            from the <a href="https://docs.opencv.org/4.0.1/d8/dfe/classcv_1_1VideoCapture.html" rel=”nofollow”>VideoCapture</a> class then this frame can be saved with the 
                            <a href="https://docs.opencv.org/4.0.1/d4/da8/group__imgcodecs.html#gabbc7ef1aa2edfaa87772f1202d67e0ce" rel=”nofollow”>imwrite</a> method.
                    </p>

                    <div class="code">
                        <code>
                            import cv2<br/><br/>

                            video = cv2.VideoCapture("./video_file.mp4")<br/><br/>
                            
                            success, image = video.read()<br/><br/>
                            
                            if success:<br/>
                            &emsp;&emsp;&emsp;&emsp;cv2.imwrite("frame.jpg", image)
                        </code>
                    </div>
                    
                    <p>
                        The method <em>read()</em> returns two values, <em>success</em> is a boolean that tell us if a frame has been grabbed and the 
                        <em>image</em> value is the frame itself.
                        
                        Then using the method <em>imwrite</em> we'll save that frame as an image file.
                    </p>
                    <p>
                            To save more than one frame or even all frames as images we need to put the read() into a loop, for instance:
                    </p>

                    <div class="code">
                        <code>
                            import cv2<br/><br/>

                            video = cv2.VideoCapture("./video_file.mp4")<br/><br/>

                            # Read the first frame<br/>
                            success, image = video.read()<br/>
                            frame_id = 0<br/><br/>

                            while success:<br/>
                            &emsp;&emsp;&emsp;&emsp;cv2.imwrite("frame{}.jpg".format(frame_id), image)<br/>
                            &emsp;&emsp;&emsp;&emsp;success, image = video.read()<br/>
                            &emsp;&emsp;&emsp;&emsp;frame_id += 1<br/>
                        </code>
                    </div>

                    <p>I created a script to save a percentage of the video frames as images. Check it out the <a href="https://github.com/davamix/frames-extractor" rel=”nofollow”>frames-extractor script</a>.</p>

                </div> <!-- post -->
                <div class="footer mt-4">
                    <a class="comments" href="https://davamix.net/posts/save-video-frames-as-images-with-opencv.html#post-comments">
                        <div id="blog-post-date4"></div>
                    </a>
                    <hr />
                    <script type="text/javascript">
                        GetTotalComments(4);
                    </script>
                </div>
                
                
                <!-- POST: Configure a self-signed certificate in Ubuntu to allow HTTPS access with an ASP.NET Core 2.1 application -->
                <div class="post">

                    <div class="title">
                        <a href="https://davamix.net/posts/asp-net-core-2-with-https.html">
                            <h1>Configure a self-signed certificate in Ubuntu to allow HTTPS access with an ASP.NET Core 2.1 application</h1>
                        </a>
                        <span class="d-flex p-2 date">17-07-2018</span>
                        <hr />
                    </div>

                    <p>1. Create an asp.net core project as usual and check if you have access using HTTPS.</p>
                    <div class="code">
                        <code class="prompt">dotnet new web -o Sample</code>
                        <code class="prompt">cd Sample</code>
                        <code class="prompt">dotnet restore</code>
                        <code class="prompt">dotnet run</code>
                    </div>
                    <p>
                        1.1 Navigate to
                        <a href="https://localhost:5001" rel=”nofollow”>https://localhost:5001</a>. Can you read the message
                        <mark>Hello World!</mark>? Congrats, you can stop reading this guide. If Firefox shows you a
                        <mark>Secure Connection Failed</mark> message or you have an error message in console like this:
                    </p>
                    <div class="code">
                        <code>
                            dbug: HttpsConnectionAdapter[1]<br/>
                            Failed to authenticate HTTPS connection.<br/>
                            System.Security.Authentication.AuthenticationException: Authentication failed, see inner exception. ---> Interop+Crypto+OpenSslCryptographicException: error:2006D002:BIO routines:BIO_new_file:system lib<br/>
                        </code>
                    </div>
                    Keep reading.

                    <p>2. Install<mark>ca-certificates</mark> and <mark>openssl</mark> packages</p>
                    <div class="code">
                        <code class="prompt">
                            sudo apt-get install ca-certificates openssl
                        </code>
                    </div>
                    
                    <p>3. Genereate the .pfx certificate with dotnet command [<a href="#link1">1</a>]</p>
                    <div class="code">
                        <code class="prompt">
                            dotnet dev-certs https -ep ${HOME}/.aspnet/https/aspnetapp.pfx -p crypticpassword
                        </code>
                    </div>
                    
                    <p>4. Extract the .crt file [<a href="#link2">2</a>]</p>
                    <div class="code">
                        <code class="prompt">cd ${HOME}/.aspnet/https/</code>
                        <code class="prompt">openssl pkcs12 -in aspnetapp.pfx -nocerts -out aspnetapp.pfx</code>
                        <code class="prompt">openssl pkcs12 -in aspnetapp.pfx -clcerts -nokeys -out aspnetapp.crt</code>
                    </div>
                    
                    <p>5. Copy the .crt file to the certificates location [<a href="#link3">3</a>]</p>
                    <div class="code">
                        <code class="prompt">
                            sudo cp aspnetapp.crt /usr/local/share/ca-certificates/
                        </code>
                    </div>
                    
                    <p>6. Change the permissions to allow to read the certificate [<a href="#link4">4</a>]</p>
                    <div class="code">
                        <code class="prompt">
                            sudo chmod +r /usr/local/share/ca-certificates/*
                        </code>
                    </div>
                    
                    <p>7. Run the application again and check the https address</p>
                    <div class="code">
                        <code class="prompt">
                            dotnet run
                        </code>
                    </div>
                    <p>
                        Navigate to <a href="https://localhost:5001" rel=”nofollow”>https://localhost:5001</a>. If you have any error, you can check the links below to know more about each step.
                    </p>
                    <div class="post-links-section">
                        <h2>LINKS</h2>
                        <span id="link1">[1] <a href="https://github.com/dotnet/dotnet-docker/blob/master/samples/aspnetapp/aspnetcore-docker-https.md" rel=”nofollow”>https://github.com/dotnet/dotnet-docker/blob/master/samples/aspnetapp/aspnetcore-docker-https.md</a></span><br />
                        <span id="link2">[2] <a href="https://www.markbrilman.nl/2011/08/howto-convert-a-pfx-to-a-seperate-key-crt-file/" rel=”nofollow”>https://www.markbrilman.nl/2011/08/howto-convert-a-pfx-to-a-seperate-key-crt-file/</a></span><br />
                        <span id="link3">[3] <a href="https://stackoverflow.com/a/44160125" rel=”nofollow”>https://stackoverflow.com/a/44160125</a></span><br />
                        <span id="link4">[4] <a href="https://github.com/dotnet/cli/issues/9376#issuecomment-393954876" rel=”nofollow”>https://github.com/dotnet/cli/issues/9376#issuecomment-393954876</a></span><br />
                    </div>
                </div> <!-- post -->

                <div class="footer mt-4">
                    <a class="comments" href="https://davamix.net/posts/asp-net-core-2-with-https.html#post-comments">
                        <div id="blog-post-date1"></div>
                    </a>
                    <hr />
                    <script type="text/javascript">
                        GetTotalComments(1);
                    </script>
                </div>

                <!-- POST: Install .NET Framework 3.5 on Windows 10-->
                <div class="post">
                        <div class="title">
                            <a href="https://davamix.net/posts/install-net-3-5-on-Windows-10.html">
                                <h1>Install .NET Framework 3.5 on Windows 10</h1>
                            </a>    
                            <span class="d-flex p-2 date">25-04-2017</span>
                            <hr />
                        </div>
    
                        <p>
                            On Windows 10 is not possible to install .NET Framework 3.5 using the <mark>Turn Windows features on or off</mark> option because the error <mark>0x800F081F</mark>.
                            In my case I installed it following the steps below:
                        </p>
                        <p>1. Go to <a href="https://my.visualstudio.com" rel=”nofollow”>https://my.visualstudio.com</a> and download <mark>Windows 10 Features on Demand</mark> iso (x86 or x64).</p>
                        <p>2. Mount the iso</p>
                        <p>3. Open a PowerShell command line as Administrator and run the next command</p>
                        <div class="code">
                            <code>Dism /online /enable-feature /featurename:NetFX3 /All /Source:D:\ /LimitAccess</code>
                        </div>
                        
                        <p>The output should something like this:</p>
                        <div class="code">
                            <code>
                                Deployment Image Servicing and Management tool<br />
                                Version: 10.0.14393.0<br />
                                <br />
                                Image Version: 10.0.14393.0<br />
                                <br />
                                Enabling feature(s)<br />
                                [==========================100.0%==========================]<br />
                                The operation completed successfully.
                            </code>
                        </div>
    
                        <p>If you go to "Turn Windows features on or off" the option fot .NET Framework 3.5 must be cheked.</p>
                    </div> <!-- post -->
                    <div class="footer mt-4">
                        <a class="comments" href="https://davamix.net/posts/install-net-3-5-on-Windows-10.html#post-comments">
                            <div id="blog-post-date2"></div>
                        </a>
                        <hr />
                        <script type="text/javascript">
                            GetTotalComments(2);
                        </script>
                    </div>

                    <!-- POST: Create and configure a local NuGet server -->
                    <div class="post">
                        <div class="title">
                            <a href="https://davamix.github.io/posts/create-local-nuget-server.html">
                                <h1>Create and configure a local NuGet server</h1>
                            </a>
                            <span class="d-flex p-2 date">17-07-2018</span>
                            <hr />
                        </div>
    
                        <p>
                            This guide will work with three project, the Nuget Server project, the Nuget Package project that contains a simple library and a Sample project to use the package created.
                        </p>
    
                        <h3>Nuget Server project</h3>
                        <p>
                            <strong>1.</strong> Install the IIS server if you don't have it yet.<br/>
                            <strong>2.</strong> Create a new site, NugetServer for example, to host the server.<br/>
                            <strong>3.</strong> Configure the port 8080 if its free, or any other as you wish.<br/>
                        </p>
                        <p>
                            From Visual Studio:<br/>
                            <strong>1.</strong> Create an ASP.NET web project with the <mark>Empty</mark> template. <br/>
                            <strong>2.</strong> Install the <mark>Nuget.Server</mark> package.<br/>
                            <span class="anchor" id="nuget-server-note1"></span>
                            <div class="note">
                                <strong>Note</strong><br/>
                                Check the <em>web.config</em> and be sure that the <mark>targetFramework</mark> version from <mark>httpRuntime</mark> entry is the same that <mark>targetFramework</mark> from <mark>compilation</mark> entry<br />
                                If you have more than once <mark>compilation</mark> entry then remove the different one.
                            </div>
                            <strong>3.</strong> Publish the project into your IIS server with the options below:
                            <div class="note">
                                <strong>Note</strong><br/>
                                To publish the project on IIS you need to run Visual Studio as Administrator;
                            </div>
                        
                            <p>Connection:</p>
                            <div class="code">
                                <code>
                                    - Publish method: Web deploy<br/>
                                    - Server: localhost (no port number)<br/>
                                    - Site name: NugetServer (site name in IIS)<br/>
                                    - Destination URL: http://localhost:8080 (site address)
                                </code>
                            </div>
    
                            <p>Settings:</p>
                            <div class="code">
                                <code>
                                    - Configuration: Release<br/>
                                    - Expand <mark>File Publish Options</mark> and check <mark>Exclude file from the App_Data folder</mark>
                                </code>
                            </div>
                        </p>
                        
                        <h3>Nuget Package project</h3>
                        <p>
                            In Visual Studio create a new <mark>Class Library</mark> project and add a simple method that returns whatever value in order to test it later in the Sample project.<br/>
                            Download <em>Nuget.exe</em> from <a href="https://www.nuget.org/downloads" target="_blank" rel=”nofollow”>https://www.nuget.org/downloads</a> and run the next command where the <em>.csproj</em> is located in order to create the <mark>.nuspec</mark> file.</p>
                        <div class="code">
                            <code class="prompt">
                                nuget.exe spec
                            </code>
                        </div>
    
                        <div class="note">
                            <strong>Note</strong><br/>
                            If you have an error like <br/>
                            <code>Unexpected token 'spec' in expression or statement. + CategoryInfo : ParserError: (:) [], ParentContainsErrorRecordException + FullyQualifiedErrorId : UnexpectedToken</code><br/>
                            Try to copy the <em>nuget.exe</em> to the same folder that <em>.csproj</em> file and run it from there.
                        </div>
                        
                        <p>Open the <em>.nuspec</em> file created and complete all information.</p>
                        <p>Build the project in <mark>Release</mark> mode and generate the nuget package with:</p>
                        <div class="code">
                            <code class="prompt">
                                nuget.exe pack Project_name.csproj -Prop Configuration=Release
                            </code>
                        </div>
                        <div class="note">
                            <strong>Note</strong><br/>
                            The previous command could fail if you don't fill correctly the <em>.nuspec</em> file.
                        </div>
                        <p>Finally copy the <em>.nupkg</em> file created into the <mark>Packages</mark> folder of the NugetServer.</p>
    
                        <h3>Sample project</h3>
                        <p>
                            Create a new <mark>Console App</mark> project and configure the Nuget repository.
                            <div class="code">
                                <code>Tools -> Nuget Package Manager -> Package Manager Settings -> Package Sources</code>
                            </div>
                            
                            <p>Add a new one with this options:</p>
                            <div class="code">
                                <code>
                                        Name: Local Server<br/>
                                        Source: http://localhost:8080/nuget<br />
                                        Click on Update then Ok
                                </code>
                            </div>
                            <div class="note">
                                <strong>Note</strong><br/>
                                If there is an error getting the list of packages from local server like the image below
                                <img src="../images/create-local-nuget-server-1.PNG" title="Error ocurred getting the packages list from local Nuget server"><br/>
                                check the Output console to know more about the error.<br/>
                                <code>
                                    [Local Server] The V2 feed at 'http://localhost:8080/Search()?$filter=IsLatestVersion&searchTerm=''&targetFramework='net47'&includePrerelease=false&$skip=0&$top=26&semVerLevel=2.0.0' returned an unexpected status code '500 Internal Server Error'.
                                </code><br/>
                                In this case the error 500 means that the sever cannot server the packages and is related with the note in the <a href="#nuget-server-note1">Nuget Server project</a> section.
                            </div>
                            If all works correctly then you have access to your package and all its classes and methods.
                        </p>
                        
                        <h3>Extra: Automatise the package creation</h3>
                        <p>
                            This is an alternative version of the Nuget Package project. Instead of create the package and copy it to the server manually, these tasks are performed by a script when you build the project.
                            </p>
                            <p>
                            Start in the same way creating the <mark>Class Library</mark> project and create a folder <mark>Tools</mark> in the solution folder then copy the <em>nuget.exe</em> file into it.<br/>
                            Create a <mark>Post-Build event</mark> with the content below to create the nuget package automatically and be moved to the Packages folder of the Nuget server</p>
                            <div class="code">
                                <code>
                                    "$(SolutionDir)Tools\nuget.exe" pack "$(ProjectPath)" -Prop Configuration=Release<br/>
                                    <br/>
                                    if exist "$(TargetDir)*.nupkg" (<br/>
                                    &emsp;&emsp;move "$(TargetDir)*.nupkg" "D:\path_to_server\Packages"<br/>
                                    )
                                </code>
                            </div>         
                            Be sure that the version of the library has been incremented after the build. I use <a href="https://visualstudiogallery.msdn.microsoft.com/dd8c5682-58a4-4c13-a0b4-9eadaba919fe/" rel=”nofollow”>Automatic Versions</a>
                            Now if you build several times you can check in the Sample project the latest version available for download.
                            <div class="note">
                                <strong>Note</strong><br/>
                                If you don't see the new versions available that means the new nuget packages has not been generated.<br/>
                                You can check all versions available of the package in the <em>Packages/package_name</em> folder on Nuget Sever. If there is only one, means that something gone wrong.<br />
                                If you are reusing the Nuget Package Sample project be sure to remove the <em>.nuspec</em> and <em>.nupkg</em> files from project folder because you don't needed now also remove the <em>.nupkg</em> file from the Nuget Server that you copied manually.
                            </div>
                        </p>
    
                        <div class="post-references-section">
                            <h2>References</h2>
                            <a href="http://docs.nuget.org/create/hosting-your-own-nuget-feeds" target="_blank" rel=”nofollow”>Hosting Your Own NuGet Feeds</a><br/>
                            <a href="http://docs.nuget.org/create/Creating-and-Publishing-a-Package" target="_blank" rel=”nofollow”>Creating and Publishing a Package</a>
                        </div>
                    </div> <!-- post -->
                    <div class="footer mt-4">
                        <a class="comments" href="https://davamix.net/posts/create-local-nuget-server.html#post-comments">
                            <div id="blog-post-date3"></div>
                        </a>
                        <hr />
                        <script type="text/javascript">
                            GetTotalComments(3);
                        </script>
                    </div>


                    
        
                

            </div>
        </div> <!-- blog -->
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
        <script defer src="https://pro.fontawesome.com/releases/v5.2.0/js/all.js" integrity="sha384-yBZ34R8uZDBb7pIwm+whKmsCiRDZXCW1vPPn/3Gz0xm4E95frfRNrOmAUfGbSGqN" crossorigin="anonymous"></script>
    <!-- DEV -->    
    <!-- <script defer src="./tools/Font-Awesome-Pro-master/js/all.js"></script> -->
</body>

</html>